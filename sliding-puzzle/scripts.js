var $button,$error,$result,$textarea,Solver,pp,puzzle,solver,updateView;pp=console.log.bind(console),Solver=function(){function e(){this.callbacks=[]}return e.prototype.onMessage=function(e){this.callbacks.push(e)},e.prototype.parseBoard=function(e){return this.board=e.trim().split("\n").map(function(e){return e.trim().split(/\D+/).map(function(e){return parseInt(e,10)})}),this},e.prototype.stop=function(){var e;return null!=(e=this.worker)&&e.terminate(),this.worker=null,this},e.prototype.run=function(){var e,t,r,a;if(!this.worker){for(this.worker=new Worker("solver.js"),t=0,r=(a=this.callbacks).length;t<r;t++)e=a[t],this.worker.addEventListener("message",e,!1);this.worker.postMessage({board:this.board})}return this},e}(),$result=$("#result"),$error=$("#error"),$textarea=$("form textarea"),$button=$("form button"),(solver=new Solver).onMessage(function(e){switch(e.data.type){case"result":puzzle.init(solver.board,e.data.value),puzzle.renderNextMove(),solver.stop();break;case"error":console.error(e.data),$error.show().find("p").text(e.data.value),solver.stop();break;case"debug":console.log.apply(console,e.data.value)}updateView()}),updateView=function(){solver.worker?($button.text("とめる"),$textarea.prop("disabled",!0)):($button.text("さがす"),$textarea.prop("disabled",!1))},$("form").submit(function(){return solver.worker?solver.stop():(solver.parseBoard($textarea.val()),$result.hide(),$error.hide(),solver.run()),updateView(),!1}),updateView(),"localhost"===location.hostname&&$("form").submit(),puzzle={moves:{u:{x:0,y:-1,path:"u"},r:{x:1,y:0,path:"r"},d:{x:0,y:1,path:"d"},l:{x:-1,y:0,path:"l"}},init:function(e,t){var r,a,o,s,n,l,u,i,p,d,c;for(a=$result.find("#puzzle").empty(),i=-1,o=e.length,p=e[0].length,c=s=0,l=o;s<l;c=s+=1)for(d=n=0,u=p;n<u;d=n+=1)r=$("<span>").text(e[c][d]).appendTo(a),this.updatePanel(r,d,c),e[c][d]||(i={x:d,y:c});a.css({width:2*p+"em",height:2*o+"em"}),$result.data({actions:t,index:-1,space:i}).show()},getPanel:function(e,t){return $("#puzzle span[data-x="+Number(e)+"][data-y="+Number(t)+"]")},updatePanel:function(e,t,r){return e.attr({"data-x":t,"data-y":r}).css({left:2*t+"em",top:2*r+"em"})},renderNextMove:function(){var e,t,r,a;a=$result.data("space"),t=$result.data("index")+1,(e=$result.data("actions")[t])&&(r=this.moves[e],$("#puzzle span").removeClass("next-move"),this.getPanel(a.x+r.x,a.y+r.y).addClass("next-move"))},renderMoved:function(){var e,t,r,a,o,s,n,l;s=$result.data("space"),a=$result.data("index")+1,(r=$result.data("actions")[a])&&(o=this.moves[r],n=s.x+o.x,l=s.y+o.y,t=this.getPanel(s.x,s.y),e=this.getPanel(n,l),this.updatePanel(t,n,l),this.updatePanel(e,s.x,s.y),$result.data({index:a,space:{x:n,y:l}}))}},$('button[rel="next"]').click(function(){return puzzle.renderMoved(),puzzle.renderNextMove(),!1});